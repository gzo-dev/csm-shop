"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.validatelogin = exports.userImplant = exports.loginCheck = void 0;
var _passport = _interopRequireDefault(require("passport"));
var _jsonwebtoken = _interopRequireDefault(require("jsonwebtoken"));
var _config = _interopRequireDefault(require("../config"));
var JWTSign = function JWTSign(user, date) {
  return _jsonwebtoken["default"].sign({
    // iss : config.app.name,
    sub: user.id,
    iat: date.getTime(),
    exp: new Date().setMinutes(date.getMinutes() + 30)
  }, process.env.JWT_SECRET);
};
var loginCheck = function loginCheck() {
  return function (req, res, next) {
    var token = null;
    if (req && req.cookies) {
      token = req.cookies['XSRF-token'];
    }
    if (token != null) {
      return res.redirect('/');
    }
    next();
  };
};
exports.loginCheck = loginCheck;
var validatelogin = function validatelogin(req, res, next) {
  _passport["default"].authenticate('jwt', {
    session: false
  }, function (err, user, info) {
    var contype = req.headers['content-type'];
    var json = !(!contype || contype.indexOf('application/json') !== 0);
    if (err && err == 'expired') {
      next();
      return;
    }
    if (err && err == 'invalid') {
      next();
      return;
    }
    if (err && err == 'user') {
      next();
      return;
    }
    if (err && Object.keys(err).length) {
      next();
      return;
    }
    if (err) {
      next();
      return;
    }
    if (!user) {
      next();
      return;
    }

    //Update Token
    var date = new Date();
    var token = JWTSign(user, date);
    res.cookie('XSRF-token', token, {
      expire: new Date().setMinutes(date.getMinutes() + 30),
      httpOnly: true,
      secure: true
    });
    req.user = user;
    next();
  })(req, res, next);
};
exports.validatelogin = validatelogin;
var userImplant = function userImplant(req, res, next) {
  res.locals.user = req.user;
  next();
};
exports.userImplant = userImplant;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfcGFzc3BvcnQiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9qc29ud2VidG9rZW4iLCJfY29uZmlnIiwiSldUU2lnbiIsInVzZXIiLCJkYXRlIiwiSldUIiwic2lnbiIsInN1YiIsImlkIiwiaWF0IiwiZ2V0VGltZSIsImV4cCIsIkRhdGUiLCJzZXRNaW51dGVzIiwiZ2V0TWludXRlcyIsInByb2Nlc3MiLCJlbnYiLCJKV1RfU0VDUkVUIiwibG9naW5DaGVjayIsInJlcSIsInJlcyIsIm5leHQiLCJ0b2tlbiIsImNvb2tpZXMiLCJyZWRpcmVjdCIsImV4cG9ydHMiLCJ2YWxpZGF0ZWxvZ2luIiwicGFzc3BvcnQiLCJhdXRoZW50aWNhdGUiLCJzZXNzaW9uIiwiZXJyIiwiaW5mbyIsImNvbnR5cGUiLCJoZWFkZXJzIiwianNvbiIsImluZGV4T2YiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwiY29va2llIiwiZXhwaXJlIiwiaHR0cE9ubHkiLCJzZWN1cmUiLCJ1c2VySW1wbGFudCIsImxvY2FscyJdLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taWRkbGV3YXJlL2F1dGguanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhc3Nwb3J0IGZyb20gJ3Bhc3Nwb3J0JztcbmltcG9ydCBKV1QgZnJvbSAnanNvbndlYnRva2VuJztcbmltcG9ydCBjb25maWcgZnJvbSAnLi4vY29uZmlnJztcblxuY29uc3QgSldUU2lnbiA9IGZ1bmN0aW9uKHVzZXIsIGRhdGUpe1xuICAgIHJldHVybiBKV1Quc2lnbih7XG4gICAgICAgIC8vIGlzcyA6IGNvbmZpZy5hcHAubmFtZSxcbiAgICAgICAgc3ViIDogdXNlci5pZCxcbiAgICAgICAgaWF0IDogZGF0ZS5nZXRUaW1lKCksXG4gICAgICAgIGV4cCA6IG5ldyBEYXRlKCkuc2V0TWludXRlcyhkYXRlLmdldE1pbnV0ZXMoKSArIDMwKVxuICAgIH0sIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQpO1xufVxuZXhwb3J0IGNvbnN0IGxvZ2luQ2hlY2sgPSAoKSA9PiB7XG4gICAgcmV0dXJuIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgICAgICB2YXIgdG9rZW4gPSBudWxsOyAgIFxuICAgICAgICBpZiAocmVxICYmIHJlcS5jb29raWVzKXtcbiAgICAgICAgICAgIHRva2VuID0gcmVxLmNvb2tpZXNbJ1hTUkYtdG9rZW4nXTtcbiAgICAgICAgfVxuICAgICAgICBpZih0b2tlbiAhPSBudWxsKXtcbiAgICAgICAgICAgIHJldHVybiByZXMucmVkaXJlY3QoJy8nKTtcbiAgICAgICAgfVxuICAgICAgICBuZXh0KCk7XG4gICAgfVxufVxuZXhwb3J0IGNvbnN0IHZhbGlkYXRlbG9naW4gPSAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICBwYXNzcG9ydC5hdXRoZW50aWNhdGUoJ2p3dCcsIHtzZXNzaW9uOiBmYWxzZX0sIChlcnIsIHVzZXIsIGluZm8pID0+IHtcbiAgICAgICAgbGV0IGNvbnR5cGUgPSByZXEuaGVhZGVyc1snY29udGVudC10eXBlJ107XG4gICAgICAgIHZhciBqc29uID0gISghY29udHlwZSB8fCBjb250eXBlLmluZGV4T2YoJ2FwcGxpY2F0aW9uL2pzb24nKSAhPT0gMCk7XG4gICAgICAgIGlmIChlcnIgJiYgZXJyID09ICdleHBpcmVkJyl7IG5leHQoKTtyZXR1cm4gOyB9XG4gICAgICAgIGlmIChlcnIgJiYgZXJyID09ICdpbnZhbGlkJyl7IG5leHQoKTtyZXR1cm4gOyB9XG4gICAgICAgIGlmIChlcnIgJiYgZXJyID09ICd1c2VyJyl7IG5leHQoKTtyZXR1cm4gO31cbiAgICAgICAgaWYgKGVyciAmJiBPYmplY3Qua2V5cyhlcnIpLmxlbmd0aCkgeyBuZXh0KCk7cmV0dXJuIDt9XG4gICAgICAgIGlmIChlcnIpIHsgbmV4dCgpO3JldHVybiA7fVxuICAgICAgICBpZiAoIXVzZXIpIHsgbmV4dCgpO3JldHVybiA7fVxuICAgICAgICBcbiAgICAgICAgLy9VcGRhdGUgVG9rZW5cbiAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICB2YXIgdG9rZW4gPSBKV1RTaWduKHVzZXIsIGRhdGUpO1xuICAgICAgICByZXMuY29va2llKCdYU1JGLXRva2VuJywgdG9rZW4sIHtcbiAgICAgICAgICAgIGV4cGlyZTogbmV3IERhdGUoKS5zZXRNaW51dGVzKGRhdGUuZ2V0TWludXRlcygpICsgMzApLFxuICAgICAgICAgICAgaHR0cE9ubHk6IHRydWUsIHNlY3VyZTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICByZXEudXNlciA9IHVzZXI7XG4gICAgICAgIG5leHQoKTtcbiAgICB9KShyZXEsIHJlcywgbmV4dCk7XG59O1xuXG5leHBvcnQgdmFyIHVzZXJJbXBsYW50ID0gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgcmVzLmxvY2Fscy51c2VyID0gcmVxLnVzZXI7XG4gICAgbmV4dCgpO1xufSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLElBQUFBLFNBQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLGFBQUEsR0FBQUYsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFFLE9BQUEsR0FBQUgsc0JBQUEsQ0FBQUMsT0FBQTtBQUVBLElBQU1HLE9BQU8sR0FBRyxTQUFWQSxPQUFPQSxDQUFZQyxJQUFJLEVBQUVDLElBQUksRUFBQztFQUNoQyxPQUFPQyx3QkFBRyxDQUFDQyxJQUFJLENBQUM7SUFDWjtJQUNBQyxHQUFHLEVBQUdKLElBQUksQ0FBQ0ssRUFBRTtJQUNiQyxHQUFHLEVBQUdMLElBQUksQ0FBQ00sT0FBTyxDQUFDLENBQUM7SUFDcEJDLEdBQUcsRUFBRyxJQUFJQyxJQUFJLENBQUMsQ0FBQyxDQUFDQyxVQUFVLENBQUNULElBQUksQ0FBQ1UsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFO0VBQ3RELENBQUMsRUFBRUMsT0FBTyxDQUFDQyxHQUFHLENBQUNDLFVBQVUsQ0FBQztBQUM5QixDQUFDO0FBQ00sSUFBTUMsVUFBVSxHQUFHLFNBQWJBLFVBQVVBLENBQUEsRUFBUztFQUM1QixPQUFPLFVBQUNDLEdBQUcsRUFBRUMsR0FBRyxFQUFFQyxJQUFJLEVBQUs7SUFDdkIsSUFBSUMsS0FBSyxHQUFHLElBQUk7SUFDaEIsSUFBSUgsR0FBRyxJQUFJQSxHQUFHLENBQUNJLE9BQU8sRUFBQztNQUNuQkQsS0FBSyxHQUFHSCxHQUFHLENBQUNJLE9BQU8sQ0FBQyxZQUFZLENBQUM7SUFDckM7SUFDQSxJQUFHRCxLQUFLLElBQUksSUFBSSxFQUFDO01BQ2IsT0FBT0YsR0FBRyxDQUFDSSxRQUFRLENBQUMsR0FBRyxDQUFDO0lBQzVCO0lBQ0FILElBQUksQ0FBQyxDQUFDO0VBQ1YsQ0FBQztBQUNMLENBQUM7QUFBQUksT0FBQSxDQUFBUCxVQUFBLEdBQUFBLFVBQUE7QUFDTSxJQUFNUSxhQUFhLEdBQUcsU0FBaEJBLGFBQWFBLENBQUlQLEdBQUcsRUFBRUMsR0FBRyxFQUFFQyxJQUFJLEVBQUs7RUFDN0NNLG9CQUFRLENBQUNDLFlBQVksQ0FBQyxLQUFLLEVBQUU7SUFBQ0MsT0FBTyxFQUFFO0VBQUssQ0FBQyxFQUFFLFVBQUNDLEdBQUcsRUFBRTNCLElBQUksRUFBRTRCLElBQUksRUFBSztJQUNoRSxJQUFJQyxPQUFPLEdBQUdiLEdBQUcsQ0FBQ2MsT0FBTyxDQUFDLGNBQWMsQ0FBQztJQUN6QyxJQUFJQyxJQUFJLEdBQUcsRUFBRSxDQUFDRixPQUFPLElBQUlBLE9BQU8sQ0FBQ0csT0FBTyxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ25FLElBQUlMLEdBQUcsSUFBSUEsR0FBRyxJQUFJLFNBQVMsRUFBQztNQUFFVCxJQUFJLENBQUMsQ0FBQztNQUFDO0lBQVM7SUFDOUMsSUFBSVMsR0FBRyxJQUFJQSxHQUFHLElBQUksU0FBUyxFQUFDO01BQUVULElBQUksQ0FBQyxDQUFDO01BQUM7SUFBUztJQUM5QyxJQUFJUyxHQUFHLElBQUlBLEdBQUcsSUFBSSxNQUFNLEVBQUM7TUFBRVQsSUFBSSxDQUFDLENBQUM7TUFBQztJQUFRO0lBQzFDLElBQUlTLEdBQUcsSUFBSU0sTUFBTSxDQUFDQyxJQUFJLENBQUNQLEdBQUcsQ0FBQyxDQUFDUSxNQUFNLEVBQUU7TUFBRWpCLElBQUksQ0FBQyxDQUFDO01BQUM7SUFBUTtJQUNyRCxJQUFJUyxHQUFHLEVBQUU7TUFBRVQsSUFBSSxDQUFDLENBQUM7TUFBQztJQUFRO0lBQzFCLElBQUksQ0FBQ2xCLElBQUksRUFBRTtNQUFFa0IsSUFBSSxDQUFDLENBQUM7TUFBQztJQUFROztJQUU1QjtJQUNBLElBQUlqQixJQUFJLEdBQUcsSUFBSVEsSUFBSSxDQUFDLENBQUM7SUFDckIsSUFBSVUsS0FBSyxHQUFHcEIsT0FBTyxDQUFDQyxJQUFJLEVBQUVDLElBQUksQ0FBQztJQUMvQmdCLEdBQUcsQ0FBQ21CLE1BQU0sQ0FBQyxZQUFZLEVBQUVqQixLQUFLLEVBQUU7TUFDNUJrQixNQUFNLEVBQUUsSUFBSTVCLElBQUksQ0FBQyxDQUFDLENBQUNDLFVBQVUsQ0FBQ1QsSUFBSSxDQUFDVSxVQUFVLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztNQUNyRDJCLFFBQVEsRUFBRSxJQUFJO01BQUVDLE1BQU0sRUFBRTtJQUM1QixDQUFDLENBQUM7SUFFRnZCLEdBQUcsQ0FBQ2hCLElBQUksR0FBR0EsSUFBSTtJQUNma0IsSUFBSSxDQUFDLENBQUM7RUFDVixDQUFDLENBQUMsQ0FBQ0YsR0FBRyxFQUFFQyxHQUFHLEVBQUVDLElBQUksQ0FBQztBQUN0QixDQUFDO0FBQUNJLE9BQUEsQ0FBQUMsYUFBQSxHQUFBQSxhQUFBO0FBRUssSUFBSWlCLFdBQVcsR0FBRyxTQUFkQSxXQUFXQSxDQUFJeEIsR0FBRyxFQUFFQyxHQUFHLEVBQUVDLElBQUksRUFBSztFQUN6Q0QsR0FBRyxDQUFDd0IsTUFBTSxDQUFDekMsSUFBSSxHQUFHZ0IsR0FBRyxDQUFDaEIsSUFBSTtFQUMxQmtCLElBQUksQ0FBQyxDQUFDO0FBQ1YsQ0FBQztBQUFBSSxPQUFBLENBQUFrQixXQUFBLEdBQUFBLFdBQUEifQ==